{% extends 'base.html' %}
{% block title %}Voice Input - Expense Tracker{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            
            <ul class="nav nav-pills nav-fill mb-4 gap-2 shadow-sm p-1 bg-white rounded-pill">
                <li class="nav-item">
                    <a class="nav-link rounded-pill" href="{% url 'expenses:create' %}"><i class="fas fa-keyboard"></i> Manual</a>
                </li>
                {% if user.preferences.ai_suggestions_enabled %}
                <li class="nav-item">
                    <a class="nav-link rounded-pill" href="{% url 'expenses:receipt_upload' %}"><i class="fas fa-camera"></i> Receipt</a>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link active rounded-pill" href="#"><i class="fas fa-microphone"></i> Voice</a>
                </li>
                {% if user.preferences.ai_suggestions_enabled %}
                <li class="nav-item">
                    <a class="nav-link rounded-pill" href="{% url 'expenses:text_parse' %}"><i class="fas fa-magic"></i> AI Text</a>
                </li>
                {% endif %}
            </ul>

            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-body text-center p-5">
                    
                    <div style="height: 120px;" class="d-flex align-items-center justify-content-center mb-3">
                        <div id="mic-container" class="rounded-circle bg-light p-4 transition-all">
                            <i id="mic-icon" class="fas fa-microphone-alt text-secondary fa-4x"></i>
                        </div>
                    </div>

                    <h4 class="fw-bold">Voice Entry</h4>
                    <p class="text-muted mb-4">
                        Tap the mic and say: <br>
                        <span class="fst-italic text-primary">"Spent 15 dollars at Starbucks for coffee"</span>
                    </p>

                    <form method="post" id="voiceForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <textarea name="voice_text" id="voice_text" class="form-control form-control-lg bg-light border-0 text-center" rows="2" placeholder="Listening..."></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-danger btn-lg rounded-pill" onclick="toggleRecording()">
                                <i class="fas fa-circle"></i> <span id="btn-text">Start Recording</span>
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm">
                                <i class="fas fa-check"></i> Save Expense
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let recognition;
    let isRecording = false;

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
            document.getElementById('mic-icon').className = 'fas fa-microphone-alt text-white fa-4x';
            document.getElementById('mic-container').className = 'rounded-circle bg-danger p-4 shadow-lg'; // Red Pulse
            document.getElementById('btn-text').innerText = "Stop Recording";
            isRecording = true;
        };

        recognition.onend = function() {
            document.getElementById('mic-icon').className = 'fas fa-microphone-alt text-secondary fa-4x';
            document.getElementById('mic-container').className = 'rounded-circle bg-light p-4';
            document.getElementById('btn-text').innerText = "Start Recording";
            isRecording = false;
        };

        recognition.onresult = function(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                transcript += event.results[i][0].transcript;
            }
            document.getElementById('voice_text').value = transcript;
        };
    } else {
        alert("Voice input requires Google Chrome.");
    }

    function toggleRecording() {
        if (isRecording) recognition.stop();
        else recognition.start();
    }
</script>
{% endblock %}